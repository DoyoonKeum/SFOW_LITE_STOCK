<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.ReqMgmt">

	<resultMap type="reqMgmtDTO" id="reqMgmtDTOid">
		<result property="in_number" column="in_number"/>
		<result property="in_free" column="in_free"/>
		<result property="in_type" column="in_type"/>
		<result property="in_trans_type" column="in_trans_type"/>
		<result property="in_date" column="in_date"/>
		<result property="client_code" column="client_code"/>
		<result property="client_name" column="client_name"/>
		<result property="in_regdate" column="in_regdate"/>
		<result property="in_empid" column="in_empid"/>
		<result property="in_delyn" column="in_delyn"/>
		<result property="memo" column="memo"/>
		<result property="request_number" column="request_number"/>
		<result property="no" column="no"/>
	</resultMap> 
	
	<resultMap type="reqMgmtDetailDTO" id="reqMgmtDetailDTOid">
		<result property="in_order" column="in_order"/>
		<result property="item_code" column="item_code"/>
		<result property="item_name" column="item_name"/>
		<result property="item_no" column="item_no"/>
		<result property="item_specification" column="item_specification"/>
		<result property="item_stock_unit" column="item_stock_unit"/>
		<result property="warehouse_code" column="warehouse_code"/>
		<result property="warehouse_name" column="warehouse_name"/>
		<result property="request_quantity" column="request_quantity"/>
		<result property="price" column="price"/>
		<result property="amount" column="amount"/>
		<result property="tax_amount" column="tax_amount"/>
		<result property="memo" column="memo"/>
		<result property="in_number" column="in_number"/>
		<result property="in_quantity" column="in_quantity"/>
		<result property="request_order" column="request_order"/>
	</resultMap> 

	<!-- 입고관리 리스트 조건없는-->
<!-- 	<select id="reqMgmtAllList" resultMap="reqMgmtDTOid">
		<![CDATA[
			select pi.in_number,pi.in_empid, pi.in_type, pi.in_date, pi.in_trans_type, pi.in_delyn, pr.request_number, mcc.client_code, mcc.client_name, pi.in_regdate, pr.memo, pi.in_free
			from po_in pi, po_request pr, ma_client_company mcc
			where pi.request_number = pr.request_number 
			and pi.client_code= mcc.client_code
			and pi.in_delyn='N'
		]]> 	
	</select> -->
	<!-- 검색리스트 -->
	<select id="reqMgmtList" resultMap="reqMgmtDTOid">
		<![CDATA[
			select pi.in_number,pi.in_empid, pi.in_type, pi.in_date, pi.in_trans_type,pi.in_delyn, pr.request_number, mcc.client_code, mcc.client_name, pi.in_regdate,pr.memo,pi.in_free
			from po_in pi, po_request pr, ma_client_company mcc
			where pi.request_number = pr.request_number 
			and pi.no= mcc.no
			and pi.in_delyn='N'
			and COALESCE(pi.in_number, '') LIKE CONCAT('%', #{in_number}, '%')
			and COALESCE(pi.in_type, '') LIKE CONCAT('%', #{in_type}, '%')
			and COALESCE(pi.in_date, '') LIKE CONCAT('%', #{in_date}, '%')
			and COALESCE(pi.in_trans_type, '') LIKE CONCAT('%', #{in_trans_type}, '%')
			and COALESCE(mcc.client_code, '') LIKE CONCAT('%', #{client_code}, '%')
			and COALESCE(mcc.client_name, '') LIKE CONCAT('%', #{client_name}, '%')
			and COALESCE(pi.in_free, '') LIKE CONCAT('%', #{in_free}, '%')
			and COALESCE(pr.memo, '') LIKE CONCAT('%', #{memo}, '%');
		]]>	
	</select>
<!-- and COALESCE(pi.in_date, '') =Date (#{in_date}) -->

	<!-- 입고관리 보기  -->
<!-- 	<select id="reqMgDetailFrm" resultType="reqMgmtDTO">
		<![CDATA[
			select pi.in_number, pi.in_empid, pi.in_type, pi.in_date, pi.in_trans_type, pr.request_number, mcc.client_code, mcc.client_name, pi.in_regdate,pr.in_memo
			from po_in pi, po_request pr, ma_client_company mcc
			where pi.request_number = pr.request_number 
			and pi.client_code= mcc.client_code
			and pi.in_delyn='N'
			and in_number = #{in_number}
			
		]]> 	
	</select> 
-->
	<!-- 입고관리 수정 -->
	<update id="reqMgmtUp" parameterType="reqMgmtDTO" >
		<![CDATA[
			update po_in pi, po_request pr, ma_client_company mcc
			set pi.in_type = #{in_type}, 
			    pi.in_free = #{in_free}, 
			    pi.in_trans_type = #{in_trans_type}, 
			    pi.in_date = #{in_date}, 
			    pi.in_regdate = now(), 
			    pi.in_empid = #{in_empid}, 
			    pr.memo = #{memo},
			    mcc.client_code = #{client_code},
			    mcc.client_name = #{client_name}
			where pi.request_number = pr.request_number
			and pi.no= mcc.no
			and pi.in_number = #{in_number}
			and pi.in_delyn='N'
		]]>
	</update>
	<!-- 입고입력 -->
	<insert id="reqMgmtIn" parameterType="reqMgmtDTO" useGeneratedKeys="true" keyProperty="in_number">
      <selectKey keyProperty="in_number" resultType="String" order="BEFORE">
         SELECT po_in_seq_12('PI') FROM DUAL
      </selectKey>
      <!-- <insert id="reqMgmtIn" parameterType="reqMgmtDTO"> -->
      <![CDATA[
			insert into po_in(in_number, in_type, in_free, in_trans_type, in_date, in_empid, request_number, no)
			values(#{in_number}, #{in_type}, #{in_free}, #{in_trans_type},#{in_date}, #{in_empid}, #{request_number}, #{no})
      ]]>
<!--      <selectKey keyColumn="reqMgmtDTO" keyProperty="reqMgmtDTO" resultType="reqMgmtDTO" order="AFTER">
         select pi.in_number,pi.in_empid, pi.in_type, pi.in_date, pi.in_trans_type,pi.in_delyn, pr.request_number, mcc.client_code, mcc.client_name, pi.in_regdate,pr.memo,pi.in_free
			from po_in pi, po_request pr, ma_client_company mcc
			where pi.request_number = pr.request_number 
			and pi.no= mcc.no
			and pi.in_delyn='N'
      </selectKey> -->
   </insert>
	
	<!-- 입고삭제-수정 -->
	<update id="reqMgmtDelUp" parameterType="reqMgmtDTO" >
		<![CDATA[
			update po_in 
			set in_delyn = 'Y'
			where in_number = #{in_number}		
		]]>
	</update>
	
	
	<!-- 입고관리 세부항목보기 -->
	<select id="reqMgmtDetail" resultMap="reqMgmtDetailDTOid" parameterType="reqMgmtDetailDTO">
		<![CDATA[
			select pid.in_order, mi.item_code, mi.item_name, mi.item_no, mi.item_specification, mi.item_stock_unit, w.warehouse_code, w.warehouse_name, prd.request_quantity, prd.price, prd.amount, prd.tax_amount, prd.memo, prd.request_order, pi.in_number, pid.in_quantity
			from po_in_detail pid, po_in pi, ma_item mi, wh w, po_request_detail prd
			where pid.in_number = pi.in_number
			and pid.item_code = mi.item_code
			and pid.warehouse_code = w.warehouse_code
			and pid.request_order = prd.request_order
			and pi.in_number=#{in_number}	
		]]> 	
	</select>
	
 	<!-- 세부항목입력 -->
	<insert id="reqMgmtDetailIn" parameterType="reqMgmtDetailDTO">

		<![CDATA[
			insert into po_in_detail (in_number, item_code, warehouse_code, request_order, in_quantity)
			values(#{in_number},#{item_code},#{warehouse_code},#{request_order},#{in_quantity})
		]]> 
	</insert>
	
	<!-- 상세보기수정 -->
 	<update id="reqMgmtDetailUp" parameterType="reqMgmtDetailDTO" >
		<![CDATA[
			update po_in_detail pid, ma_item mi, wh w, po_request_detail prd
			set mi.item_code=#{item_code}, 
				w.warehouse_code=#{warehouse_code}, 
				prd.memo=#{memo},
				pid.in_quantity=#{in_quantity}
			where pid.item_code = mi.item_code 
			and pid.warehouse_code = w.warehouse_code
			and pid.request_order = prd.request_order
			and pid.in_order = #{in_order}		
		]]>
	</update>


	
	
	
	

</mapper>